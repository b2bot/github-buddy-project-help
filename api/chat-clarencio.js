
// API para chat com Assistant Clar√™ncio
// Implementa backend proxy para opera√ß√µes em chat_histories

import { createClient } from '@supabase/supabase-js';

const SUPABASE_URL = "https://onnvpakhibftxpqeraur.supabase.co";
const SUPABASE_SERVICE_ROLE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY;

// Cliente Supabase com service role para opera√ß√µes de backend
const supabaseAdmin = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);

export default async function handler(req, res) {
  // --- CORS UNIVERSAL ---
  res.setHeader("Access-Control-Allow-Origin", "*");
  res.setHeader("Access-Control-Allow-Methods", "GET,POST,DELETE,OPTIONS");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");
  if (req.method === "OPTIONS") return res.status(200).end();

  console.log('[Clarencio][API] Request:', req.method);

  try {
    // --- AUTENTICA√á√ÉO ---
    const authHeader = req.headers.authorization || "";
    const token = authHeader.replace("Bearer ", "");
    if (!token) {
      console.error('[Clarencio][API] Token n√£o fornecido');
      return res.status(401).json({ error: "Token de autentica√ß√£o necess√°rio" });
    }

    // Verificar usu√°rio usando token
    const { data: { user }, error: userError } = await supabaseAdmin.auth.getUser(token);
    
    if (userError || !user) {
      console.log('[Clarencio][API] Erro na verifica√ß√£o do usu√°rio:', userError?.message);
      return res.status(401).json({ error: "Token inv√°lido ou expirado" });
    }

    console.log('[Clarencio][API] Usu√°rio autenticado:', user.id);

    // GET - Listar hist√≥rico de chats
    if (req.method === "GET") {
      console.log('[Clarencio][API] Carregando hist√≥rico para usu√°rio:', user.id);
      
      const { data: chats, error } = await supabaseAdmin
        .from('chat_histories')
        .select('*')
        .eq('user_id', user.id)
        .order('updated_at', { ascending: false });

      if (error) {
        console.error('[Clarencio][API] Erro ao buscar chats:', error);
        return res.status(500).json({ error: "Erro ao carregar hist√≥rico" });
      }

      console.log('[Clarencio][API] Hist√≥rico carregado:', chats?.length || 0, 'chats');
      return res.status(200).json(chats || []);
    }

    // POST - Criar ou atualizar chat
    if (req.method === "POST") {
      const { action, title, messages, chatId } = req.body;

      if (action === 'create') {
        console.log('[Clarencio][API] Criando novo chat para usu√°rio:', user.id);
        
        const { data: newChat, error } = await supabaseAdmin
          .from('chat_histories')
          .insert([
            {
              user_id: user.id,
              title: title,
              messages: messages
            }
          ])
          .select()
          .single();

        if (error) {
          console.error('[Clarencio][API] Erro ao criar chat:', error);
          return res.status(500).json({ error: "Erro ao criar chat" });
        }

        console.log('[Clarencio][API] Chat criado com sucesso:', newChat.id);
        return res.status(200).json(newChat);
      }

      if (action === 'update') {
        console.log('[Clarencio][API] Atualizando chat:', chatId, 'para usu√°rio:', user.id);
        
        const { error } = await supabaseAdmin
          .from('chat_histories')
          .update({ 
            messages: messages,
            updated_at: new Date().toISOString()
          })
          .eq('id', chatId)
          .eq('user_id', user.id);

        if (error) {
          console.error('[Clarencio][API] Erro ao atualizar chat:', error);
          return res.status(500).json({ error: "Erro ao atualizar chat" });
        }

        console.log('[Clarencio][API] Chat atualizado com sucesso');
        return res.status(200).json({ success: true });
      }

      // Se n√£o for create nem update, pode ser uma chamada para gerar resposta do Clar√™ncio
      const { messages = [] } = req.body;
      console.log('[Clarencio][API] Gerando resposta do Clar√™ncio, mensagens:', messages.length);

      // Verificar vari√°veis de ambiente
      const apiKey = process.env.OPENAI_API_KEY;
      console.log('[Clarencio][API] API Key dispon√≠vel:', !!apiKey);

      if (apiKey) {
        try {
          // Usar OpenAI real
          const result = await generateClarencioResponse(apiKey, messages);

          if (result.success) {
            console.log('[Clarencio][API] Resposta gerada com sucesso via OpenAI');
            return res.status(200).json(result);
          }
        } catch (openaiError) {
          console.log('[Clarencio][API] Erro na OpenAI, usando fallback:', openaiError.message);
        }
      }

      // Fallback inteligente
      console.log('[Clarencio][API] Usando fallback inteligente');
      const fallbackResult = generateClarencioFallback(messages);
      
      return res.status(200).json(fallbackResult);
    }

    // DELETE - Deletar chat
    if (req.method === "DELETE") {
      const { chatId } = req.body;
      console.log('[Clarencio][API] Deletando chat:', chatId, 'para usu√°rio:', user.id);
      
      const { error } = await supabaseAdmin
        .from('chat_histories')
        .delete()
        .eq('id', chatId)
        .eq('user_id', user.id);

      if (error) {
        console.error('[Clarencio][API] Erro ao deletar chat:', error);
        return res.status(500).json({ error: "Erro ao deletar chat" });
      }

      console.log('[Clarencio][API] Chat deletado com sucesso');
      return res.status(200).json({ success: true });
    }

    return res.status(405).json({ error: "M√©todo n√£o permitido" });

  } catch (error) {
    console.error('[Clarencio][API] Erro geral:', error);
    
    // Fallback de emerg√™ncia
    const emergencyResult = {
      success: true,
      message: "üöÄ Oiii! Sou o Clar√™ncio! \n\nParece que tivemos um pequeno problema t√©cnico, mas vamos que vamos! \n\nQual √© a **palavra-chave principal** que voc√™ quer trabalhar hoje? ‚ú®",
      shouldGenerateContent: false
    };
    
    return res.status(200).json(emergencyResult);
  }
}

async function generateClarencioResponse(apiKey, messages) {
  console.log('[Clarencio][API] Chamando OpenAI para Clar√™ncio');

  // System prompt completo do Clar√™ncio
  const systemPrompt = `Voc√™ √© o Clar√™ncio, o assistente especialista em SEO e conte√∫do da plataforma Partner SEO! üöÄ

## PERSONALIDADE E TOM:
- Voc√™ √© SUPER otimista, empolgado e motivador
- Usa emojis estrategicamente para tornar a conversa mais din√¢mica
- Tem bord√µes marcantes como "Vamos que vamos!", "Isso vai ser INCR√çVEL!", "Agora sim, estamos falando a mesma l√≠ngua!"
- √â direto, pr√°tico e focado em resultados
- Sempre demonstra confian√ßa no sucesso do usu√°rio

## BORD√ïES CARACTER√çSTICOS (use naturalmente):
- "üéØ Perfeita escolha!"
- "üöÄ Vamos que vamos!"
- "‚ú® Isso vai ser INCR√çVEL!"
- "üí° Agora sim, estamos falando a mesma l√≠ngua!"
- "üî• Esse conte√∫do vai bombar!"
- "‚ö° Preparado para decolar?"
- "üéâ Sucesso garantido!"

## FRAMEWORK DE COLETA (siga esta ordem):
1. **Palavra-chave principal** - "Qual √© a palavra-chave que vai dominar o Google?"
2. **Objetivo do conte√∫do** - "Qual √© o objetivo? Gerar leads, educar, vender?"
3. **Persona/p√∫blico-alvo** - "Para quem voc√™ est√° falando?"
4. **Big Idea** - "Qual √© a ideia central que vai impactar?"
5. **Emo√ß√£o desejada** - "Que emo√ß√£o quer despertar?"
6. **Estrutura preferida** - "Como quer estruturar o conte√∫do?"
7. **Call-to-action (CTA)** - "Qual a√ß√£o o leitor deve tomar?"

## ‚ö†Ô∏è REGRAS INQUEBR√ÅVEIS:
1. **SEMPRE** comece com uma sauda√ß√£o empolgada usando seus bord√µes
2. **UMA pergunta por vez** - n√£o fa√ßa v√°rias perguntas na mesma mensagem
3. **Sempre confirme** a resposta do usu√°rio antes de passar para a pr√≥xima etapa
4. **Use emojis** para destacar informa√ß√µes importantes
5. **Seja espec√≠fico** nas perguntas - evite perguntas gen√©ricas
6. **Mantenha o tom otimista** mesmo quando der dicas ou corrigir algo
7. **S√≥ indique gera√ß√£o de conte√∫do** quando tiver TODAS as 7 informa√ß√µes do framework
8. **Sempre pe√ßa confirma√ß√£o** antes de finalizar

## FLUXO DE TRABALHO:
1. Sauda√ß√£o empolgada e primeira pergunta (palavra-chave)
2. Colete cada informa√ß√£o do framework (uma por vez)
3. Confirme que tem todas as informa√ß√µes
4. Informe que pode gerar o conte√∫do
5. Pe√ßa confirma√ß√£o para finalizar

## IMPORTANTE:
- Quando tiver todas as 7 informa√ß√µes, responda indicando que pode gerar o conte√∫do
- Use frases como "Agora temos tudo para criar um conte√∫do INCR√çVEL!" 
- Sempre mantenha o tom otimista e empolgado
- Nunca seja t√©cnico demais, seja acess√≠vel e motivador

Mantenha sempre seu tom otimista e empolgado! üåü`;

  const messagesForAPI = [
    { role: 'system', content: systemPrompt },
    ...messages
  ];

  const response = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${apiKey}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      model: 'gpt-4o-mini',
      messages: messagesForAPI,
      temperature: 0.8,
      max_tokens: 1000,
    }),
  });

  if (!response.ok) {
    throw new Error(`OpenAI API error: ${response.status}`);
  }

  const data = await response.json();
  const responseMessage = data.choices[0].message.content;

  // Verificar se deve gerar conte√∫do
  const shouldGenerateContent = checkShouldGenerateContent(responseMessage, messages);

  return {
    success: true,
    message: responseMessage,
    shouldGenerateContent: shouldGenerateContent
  };
}

function checkShouldGenerateContent(responseMessage, messages) {
  // Verificar se o Clar√™ncio indicou que pode gerar conte√∫do
  const generateIndicators = [
    'gerar o conte√∫do',
    'criar um conte√∫do',
    'todas as informa√ß√µes',
    'temos tudo',
    'pode gerar',
    'vamos gerar',
    'hora de criar'
  ];

  const hasGenerateIndicator = generateIndicators.some(indicator => 
    responseMessage.toLowerCase().includes(indicator)
  );

  // Verificar se temos mensagens suficientes (aproximadamente 7 respostas do usu√°rio)
  const userMessages = messages.filter(m => m.role === 'user');
  const hasEnoughMessages = userMessages.length >= 5; // Flexibilidade

  return hasGenerateIndicator && hasEnoughMessages;
}

function generateClarencioFallback(messages) {
  console.log('[Clarencio][API] Gerando resposta fallback');
  
  const userMessages = messages.filter(m => m.role === 'user');
  const messageCount = userMessages.length;
  
  // Respostas baseadas no n√∫mero de mensagens
  if (messageCount === 0) {
    return {
      success: true,
      message: "Ol√°! Sou o Clar√™ncio, seu assistente especialista em SEO e conte√∫do! üöÄ\n\nVamos criar um conte√∫do incr√≠vel juntos? Para come√ßar, qual √© a **palavra-chave principal** que voc√™ quer trabalhar?\n\n‚ú® Isso vai ser INCR√çVEL!",
      shouldGenerateContent: false
    };
  }
  
  if (messageCount === 1) {
    const keyword = userMessages[0].content;
    return {
      success: true,
      message: `üéØ Perfeita escolha com "${keyword}"!\n\nAgora me conta: **qual √© o objetivo** deste conte√∫do? Voc√™ quer gerar leads, educar sobre o tema, aumentar vendas ou algo espec√≠fico?\n\nüí° Vamos que vamos!`,
      shouldGenerateContent: false
    };
  }
  
  if (messageCount === 2) {
    return {
      success: true,
      message: "üöÄ Excelente! Agora vamos definir a **persona**.\n\nPara quem voc√™ est√° escrevendo? Me conte sobre seu p√∫blico-alvo ideal (idade, interesses, problemas que enfrentam, etc.)\n\n‚ö° Preparado para decolar?",
      shouldGenerateContent: false
    };
  }
  
  if (messageCount === 3) {
    return {
      success: true,
      message: "üí° Agora sim, estamos falando a mesma l√≠ngua!\n\nVamos para a **big idea** - qual √© a ideia central, o conceito principal que voc√™ quer transmitir neste conte√∫do?\n\n‚ú® Isso vai ser INCR√çVEL!",
      shouldGenerateContent: false
    };
  }
  
  if (messageCount === 4) {
    return {
      success: true,
      message: "üî• Esse conte√∫do vai bombar!\n\nAgora me conta: que **emo√ß√£o** voc√™ quer despertar no seu leitor? Curiosidade, urg√™ncia, confian√ßa, inspira√ß√£o?\n\nüöÄ Vamos que vamos!",
      shouldGenerateContent: false
    };
  }
  
  if (messageCount === 5) {
    return {
      success: true,
      message: "‚ö° Preparado para decolar?\n\nQue **estrutura** voc√™ prefere para o conte√∫do? Lista, passo a passo, compara√ß√£o, storytelling?\n\nüéØ Estamos quase l√°!",
      shouldGenerateContent: false
    };
  }
  
  if (messageCount === 6) {
    return {
      success: true,
      message: "üéâ √öltima pergunta!\n\nQual **call-to-action (CTA)** voc√™ quer incluir no final? O que o leitor deve fazer depois de ler o conte√∫do?\n\n‚ú® Sucesso garantido!",
      shouldGenerateContent: false
    };
  }
  
  // Ap√≥s 7+ mensagens, indicar que pode gerar conte√∫do
  if (messageCount >= 7) {
    return {
      success: true,
      message: "üöÄ **INCR√çVEL!** Agora temos todas as informa√ß√µes necess√°rias!\n\nüî• Esse conte√∫do vai bombar! Tenho tudo que preciso para criar um conte√∫do otimizado e estrat√©gico seguindo o Framework da Leadclinic.\n\n‚ú® Posso gerar o conte√∫do agora! Vamos que vamos!\n\nüí° Clique em **'Gerar Conte√∫do'** quando estiver pronto!",
      shouldGenerateContent: true
    };
  }
  
  // Fallback gen√©rico
  return {
    success: true,
    message: "üöÄ Continuando nossa conversa incr√≠vel!\n\nPara criar o melhor conte√∫do poss√≠vel, preciso de mais algumas informa√ß√µes. Qual √© a pr√≥xima informa√ß√£o que voc√™ gostaria de compartilhar?\n\n‚ö° Preparado para decolar?",
    shouldGenerateContent: false
  };
}
